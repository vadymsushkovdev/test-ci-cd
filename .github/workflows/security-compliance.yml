name: Security Compliance

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-compliance:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. Install dependencies
      - name: Install npm deps
        run: npm ci

      # 4. Install Reviewdog
      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh \
            | sh -s -- -b $(pwd) v0.13.0
          echo "$PWD" >> $GITHUB_PATH

      # 5. ESLint (with eslint-plugin-security)
      - name: Run ESLint Security Checks
        run: |
          # install ESLint & the security plugin
          npm install --no-save eslint@^9 eslint-plugin-security
          
          # ESLint will automatically load eslint.config.js
          npx eslint --ext .js,.ts . \
            -f json -o eslint-report.json
          
          reviewdog \
            -f=eslint \
            -name="ESLint Security" \
            -reporter=github-pr-review \
            -level=error \
            < eslint-report.json


      # 6. Gitleaks (secret scanning)
      - name: Install Gitleaks CLI
        run: |
          curl -sSL https://github.com/zricethezav/gitleaks/releases/download/v8.10.0/gitleaks_8.10.0_Linux_x86_64.tar.gz \
            | tar xz -C /usr/local/bin gitleaks
      - name: Run Gitleaks scan
        run: |
          gitleaks detect --source . --report-format json --report-path=gitleaks-report.json
          reviewdog \
            -f=gitleaks \
            -name="Gitleaks Secret Scan" \
            -reporter=github-pr-review \
            -level=warning \
            < gitleaks-report.json

      # 7. Trivy (filesystem vulnerability scan)
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.32.0
      - name: Run Trivy scan
        run: |
          trivy fs --format json --output trivy-report.json --ignore-unfixed .
          reviewdog \
            -f=trivy-ci \
            -name="Trivy Vulnerability Scan" \
            -reporter=github-pr-review \
            -level=error \
            < trivy-report.json
